@using Lionk.Core.Component
@inject IDialogService DialogService
@inject IComponentService ComponentService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <IComponentInstanceList Components="_components" OnComponentSelected="WidgetSelected" />
    </DialogContent>
    <DialogActions>
        <MudSpacer />
        <MudButton OnClick="ConfigureAsync">Configure </MudButton>
        <MudSpacer />
        <MudButton OnClick="Submit">Ok</MudButton>
        <MudButton OnClick="Cancel">Cancel</MudButton>
    </DialogActions>
</MudDialog>

@code {

    [CascadingParameter] MudDialogInstance? MudDialog { get; set; }
    private List<Widget> _components => ComponentService.GetInstancesOfType<Widget>().ToList();
    private Widget? _selectedWidget;
    private List<int> _componentsHash = new();

    private void WidgetSelected(Lionk.Core.Component.IComponent? component)
    {
        _selectedWidget = component as Widget;
    }

    protected override void OnInitialized()
    {
        foreach (var widget in _components)
        {
            _componentsHash.Add(widget.GetHashCode());
        }
    }

    public bool AlmostOneWidgetModified()
    {
        foreach (var widget in _components)
        {
            if (!_componentsHash.Contains(widget.GetHashCode()))
            {
                return true;
            }
        }
        return false;
    }

    private void Submit()
    {
        if (MudDialog is null) return;
        bool modified = AlmostOneWidgetModified();
        MudDialog.Close(DialogResult.Ok(new { modified }));
    }

    private void Cancel()
    {
        if (MudDialog is null) return;
        MudDialog.Cancel();
    }

    private async Task ConfigureAsync()
    {
        if (_selectedWidget is null)
        {
            Snackbar.Add("Please select a widget", Severity.Error);
            return;
        }

        DialogParameters parameters = new();
        parameters.Add("Type", _selectedWidget.ComponentType);

        var dialogReference = DialogService.Show<WidgetConfig>("Widget configuration", parameters);

        var dialogResult = await dialogReference.Result;

        if (dialogResult is not null && !dialogResult.Canceled)
        {
            Lionk.Core.Component.IComponent? component = dialogResult.Data as Lionk.Core.Component.IComponent;
            _selectedWidget.Component = component;
        }
        else
        {
            Snackbar.Add("Widget configuration cancelled", Severity.Warning);
        }
    }
}
