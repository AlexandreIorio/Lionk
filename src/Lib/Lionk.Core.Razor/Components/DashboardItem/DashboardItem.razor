@inherits MudItem
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IComponentService ComponentService

@namespace Lionk.Core.Component
@using Lionk.Core.Razor.Components

<MudItem Style=" margin-right:15px;
            margin-bottom:15px;">
    <MudPaper Class="pa-4"
              Style=" position: relative;
            height:100%;
            width:100%">
        <div style="position: absolute;
                    top: @_marginPixels;
                    right: @_marginPixels;
                    display: flex;
                    flex-direction: column;">
            @if (_isConfigurable)
            {
                <MudIconButton Icon="@Icons.Material.Filled.Settings"
                               Size="Size.Small"
                               OnClick="ConfigurableClicked" />
            }

            @if (_isDetailable)
            {
                <MudIconButton Icon="@Icons.Material.Filled.Info"
                               Size="Size.Small"
                               OnClick="DetailableClicked" />
            }
            @if (_isPageable)
            {
                <MudIconButton Icon="@Icons.Material.Filled.Pageview"
                               Size="Size.Small"
                               OnClick="PageableClicked" />
            }
            @if (_isExecutable)
            {
                <MudIconButton Icon="@Icons.Material.Filled.PlayArrow"
                               Size="Size.Small"
                               OnClick="ExecutableClicked" />
            }

        </div>
        <div style="position: absolute;
                    bottom: @_marginPixels;
                    right: @_marginPixels;
                    display: flex;
                    flex-direction: column;">



            <MudMenu Icon="@Icons.Material.Filled.MoreVert">
                <MudMenuItem IconSize="Size.Small"
                             Icon="@Icons.Material.Filled.Edit">
                    Edit
                </MudMenuItem>
                <MudMenuItem IconSize="Size.Small"
                             Icon="@Icons.Material.Filled.DeleteForever"
                             IconColor="Color.Error">
                    <MudText Color="Color.Error">Delete</MudText>
                </MudMenuItem>
            </MudMenu>



        </div>
        <DynamicComponent @ref=_dynamicComponent Type="@View" Parameters="@_parameters" />
    </MudPaper>
</MudItem>



@code {

    private const string _marginPixels = "5px";

    public Dictionary<string, object> _parameters = new();

    [Parameter]
    public Lionk.Core.Component.IComponent? Component { get; set; }
    [Parameter] public Type? View { get; set; }

    private bool _isConfigurable;
    private bool _isDetailable;
    private bool _isPageable;
    private bool _isExecutable;

    private DynamicComponent? _dynamicComponent;
    private object? _instance => _dynamicComponent?.Instance;

    protected override void OnInitialized()
    {
        if (Component is not null)
        {
            _parameters.Add("Component", Component);
        }
    }

    private void DefineButtonsState()
    {
        if (_instance is null) return;
        _isConfigurable = _instance is IConfigurableComponent;
        _isDetailable = _instance is IDetailableComponent;
        _isPageable = _instance is IPageableComponent;
        _isExecutable = _instance is IExecutableComponent;
        StateHasChanged();
    }

    protected override void OnAfterRender(bool firstRender)
    {
        base.OnAfterRender(firstRender);
        DefineButtonsState();
    }


    private void ConfigurableClicked()
    {
        if (_instance is IConfigurableComponent configurableComponent)
        {
            configurableComponent.OpenConfigurationAsync();
        }
    }

    private void DetailableClicked()
    {
        if (_instance is IDetailableComponent detailableComponent)
        {
            detailableComponent.OpenDetailAsync();
        }
    }

    private void PageableClicked()
    {
        if (_instance is IPageableComponent pageableComponent)
        {
            pageableComponent.OpenComponentPageAsync();
        }
    }

    private void ExecutableClicked()
    {
        if (_instance is IExecutableComponent executableComponent)
        {
            executableComponent.Execute();
        }
    }
}
