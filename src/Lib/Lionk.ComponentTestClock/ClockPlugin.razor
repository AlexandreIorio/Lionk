@using Lionk.Core
@using Lionk.Core.Component
@using Lionk.Core.Razor
@using MudBlazor
@inject ISnackbar Snackbar
@implements IBlazorCyclicComponent

@attribute [NamedElement("Clock", "a sweet clock widget")]
<MudCard>
    <MudCardContent>
        <MudText Typo="Typo.h3">@InstanceName</MudText>
        <MudText Typo="Typo.h4">@currentTime</MudText>
    </MudCardContent>
</MudCard>

@code {
    private string currentTime = "No time setted";

    protected override void OnInitialized()
    {
        InstanceName = "Super Clock";
        currentTime = DateTime.Now.ToString("HH:mm:ss");
        var timer = new System.Timers.Timer(1000);
        timer.Elapsed += (sender, e) => InvokeAsync(UpdateTime);
        timer.Start();
        CyclicComponent = new ClockCyclicComponent("Clock", TimeSpan.FromSeconds(1), Snackbar);
    }

    private void UpdateTime()
    {
        currentTime = DateTime.Now.ToString("HH:mm:ss");
        StateHasChanged();
    }

    public string? InstanceName { get; set; }

    public CyclicComponent? CyclicComponent { get; private set; }

    public class ClockCyclicComponent : CyclicComponent
    {
        public ClockCyclicComponent(string componentName, TimeSpan cycleTime, ISnackbar snackbar)
            : base(componentName, cycleTime)
        {
            _snackbar = snackbar;
            CyclicTask = UpdateTime;
        }

        private ISnackbar _snackbar;

        private void UpdateTime()
        {
            _snackbar.Add($"Time updated", Severity.Success);
        }
    }
}
