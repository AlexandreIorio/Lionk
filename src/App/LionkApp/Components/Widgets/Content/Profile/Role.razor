@page "/role"
@using Lionk.Auth.Identity
@using Microsoft.AspNetCore.Components.Authorization
@inject ISnackbar Snackbar
@inject UserAuthenticationStateProvider AuthStateProvider
@inject UserService userService

@if (Users != null)
{
    <MudContainer>
        <MudTable Items="Users" Bordered="true" Dense="true" Hover="true">
            <HeaderContent>
                <MudTh Style="text-align: center; font-size: 14px;">Username</MudTh>
                <MudTh Style="text-align: center; font-size: 14px;">Email</MudTh>
                <MudTh Style="text-align: center; font-size: 14px;">Roles</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd Style="font-size: 14px;">@context.Username</MudTd>
                <MudTd Style="font-size: 14px;">@context.Email</MudTd>
                <MudTd>
                    <div style="display: flex; align-items: center;">
                        @foreach (var role in AvailableRoles)
                        {
                            <div style="display: inline-flex; align-items: center; font-size: 14px; margin-right: 16px;">
                                <span style="margin-right: 8px;">@role</span>
                                <MudSwitch T="bool" @bind-Value="RoleStates[context.Id][role]" Color="Color.Primary" />
                            </div>
                        }
                    </div>
                </MudTd>
            </RowTemplate>
        </MudTable>

        <div style="text-align: right; margin-top: 20px;">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveUsers" Style="font-size: 14px;">
                Save
            </MudButton>
        </div>
    </MudContainer>
}
else
{
    <MudText Typo="Typo.body1" Align="Align.Left" Style="margin: 20px; font-size: 14px;">Loading users...</MudText>
}

@code {
    public HashSet<User>? Users;
    private List<string> AvailableRoles = new List<string> { "Admin", "User", "Moderator" };
    private Dictionary<Guid, Dictionary<string, bool>> RoleStates = new();

    protected override void OnInitialized()
    {
        base.OnInitialized();

        Users = userService.GetUsers();

        if (Users != null)
        {
            foreach (var user in Users)
            {
                RoleStates[user.Id] = new Dictionary<string, bool>();
                foreach (var role in AvailableRoles)
                {
                    RoleStates[user.Id][role] = user.Roles.Contains(role);
                }
            }
        }
    }

    private void SaveUser(User user)
    {
        foreach (var role in AvailableRoles)
        {
            bool currentRoleState = RoleStates[user.Id][role];

            if (currentRoleState && !user.Roles.Contains(role))
            {
                user.AddRole(role);
            }

            if (!currentRoleState && user.Roles.Contains(role) && (role != "Admin"))
            {
                if (user.Roles.Count > 1)
                {
                    user.RemoveRole(role);
                }
                else
                {
                    Snackbar.Add("You cannot remove the last remaining role or the admin role", Severity.Warning);
                }
            }
        }

        userService.Update(user);
    }

    private void SaveUsers()
    {
        if (Users != null)
        {
            foreach (var user in Users)
            {
                SaveUser(user);
            }
        }
   
        Snackbar.Add("All user roles updated successfully.", Severity.Success);
        StateHasChanged();
    }
}
