@page "/"
@inject ISnackbar Snackbar
@inject ICyclicExecutorService CyclicExecutorService
@inject IComponentService ComponentService
@inject IDialogService DialogService
@using Lionk.Core.Component
@using Lionk.Utils;
@using Lionk.TemperatureSensor
@using LionkApp.Components.Widgets.Buttons

<PageTitle>Dashboard</PageTitle>
<MudContainer Class="mt-16 px-8" MaxWidth="MaxWidth.False">

    @if (DashBoardItemsModels != null)
    {
        @foreach (var item in DashBoardItemsModels)
        {

            Dictionary<string, object> parameters = new();
            if (item.PropertyAndInstanceName != null)
            {
                foreach (var parameter in item.PropertyAndInstanceName)
                {
                    object? obj = ComponentService.GetInstanceByName(parameter.Value);
                    if (obj != null)
                    {
                        parameters.Add(parameter.Key, obj);
                    }
                }
            }
            <DashboardItem View="@item.View" Parameters="parameters"/>
        }
    }

</MudContainer>

<FloatingButton />

@code {

    List<DashBoardItemModel>? DashBoardItemsModels = new List<DashBoardItemModel>();

    protected override void OnInitialized()
    {
        base.OnInitialized();
        RestoreModels();
    }

    private void RestoreModels()
    {
        string json = ConfigurationUtils.ReadFile("dashboard.json", FolderType.Data);
        DashBoardItemsModels = Newtonsoft.Json.JsonConvert.DeserializeObject<List<DashBoardItemModel>>(json);
    }

    private async Task HandleConfigurableClicked(DynamicComponent? dynamicComponent)
    {
        if (dynamicComponent?.Instance is IConfigurableComponent configurableComponent)
        {
            await configurableComponent.OpenConfiguration();
        }
    }

    private async Task HandleDetailableClicked(DynamicComponent? dynamicComponent)
    {
        if (dynamicComponent?.Instance is IDetailableComponent configurableComponent)
        {
            await configurableComponent.OpenDetail();
        }
    }

    private async Task HandlePageableClicked(DynamicComponent? dynamicComponent)
    {
        if (dynamicComponent?.Instance is IPageableComponent pageableComponent)
        {
            await pageableComponent.OpenComponentPage();
        }
    }

    private void HandleExecutableClicked(DynamicComponent? dynamicComponent)
    {
        if (dynamicComponent?.Instance is IExecutableComponent executableComponent)
        {
            executableComponent.Execute();
        }
    }
}

